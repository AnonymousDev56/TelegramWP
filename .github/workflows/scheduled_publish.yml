name: Scheduled Publish

on:
  schedule:
    # Asia/Almaty (UTC+5): 08:00, 14:00, 20:00 local
    - cron: "0 3 * * *"
    - cron: "0 9 * * *"
    - cron: "0 15 * * *"
  workflow_dispatch:
    inputs:
      forecast_type:
        description: "Type to publish"
        required: true
        type: choice
        options:
          - today
          - tomorrow
          - three_days

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve forecast type
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TYPE="${{ inputs.forecast_type }}"
          else
            case "${{ github.event.schedule }}" in
              "0 3 * * *") TYPE="today" ;;
              "0 9 * * *") TYPE="tomorrow" ;;
              "0 15 * * *") TYPE="three_days" ;;
              *)
                echo "Unexpected cron expression: ${{ github.event.schedule }}"
                exit 1
                ;;
            esac
          fi
          echo "forecast_type=${TYPE}" >> "$GITHUB_OUTPUT"

      - name: Trigger publish
        env:
          PUBLISH_BASE_URL: ${{ secrets.PUBLISH_BASE_URL }}
          CRON_SECRET_TOKEN: ${{ secrets.CRON_SECRET_TOKEN }}
        run: |
          test -n "${PUBLISH_BASE_URL}" || (echo "PUBLISH_BASE_URL is missing" && exit 1)
          test -n "${CRON_SECRET_TOKEN}" || (echo "CRON_SECRET_TOKEN is missing" && exit 1)
          TYPE="${{ steps.resolve.outputs.forecast_type }}"
          echo "Triggering type=${TYPE}"
          curl -fsS -X POST "${PUBLISH_BASE_URL}/internal/publish/${TYPE}/" -H "X-Cron-Token: ${CRON_SECRET_TOKEN}"
